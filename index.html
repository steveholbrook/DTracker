<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Technical Downtime Tracking App</title>
  <!-- PWA manifest and theme color -->
  <link rel="manifest" href="manifest.webmanifest">
  <!-- Theme color influences the browser address bar and OS chrome when the app is installed -->
  <meta name="theme-color" content="#0a6ed1">
<style>
  :root{
    --sap-shell-bg:#f7f7f7;
    --sap-panel:#ffffff;
    --sap-accent:#0a6ed1;
    --sap-accent-2:#0854a0;
    --sap-text:#222;
    --sap-muted:#6a6d70;
    --sap-border:#d9d9d9;
    --sap-success:#107e3e;
    --sap-warning:#e9730c;
    --sap-error:#bb0000;
    --radius:8px;
    --gap:12px;
  }
  
  html,body{
    margin:0;
    padding:0;
    background:var(--sap-shell-bg);
    color:var(--sap-text);
    font:14px/1.4 "72","Segoe UI",Roboto,Arial,sans-serif;
  }
  
  .app-header{
    background:linear-gradient(180deg,#0b74de 0%, #095cab 100%);
    color:#fff;
    padding:12px 16px;
    display:flex;
    align-items:center;
    gap:12px;
    justify-content:space-between;
  }
  
  .brand{
    display:flex;
    align-items:center;
    gap:12px;
  }
  
  .brand svg{
    height:28px;
    width:auto;
  }
  
  h1{
    margin:0;
    font-size:18px;
    font-weight:600;
    letter-spacing:.2px;
  }
  
  .status-display{
    display:flex;
    gap:20px;
    align-items:center;
    font-size:13px;
  }
  
  .status-item{
    display:flex;
    flex-direction:column;
    align-items:center;
  }
  
  .status-label{
    opacity:0.9;
    font-size:11px;
  }
  
  .status-value{
    font-size:16px;
    font-weight:700;
  }
  
  .content{
    padding:16px;
  }
  
  .panel{
    background:var(--sap-panel);
    border:1px solid var(--sap-border);
    border-radius:var(--radius);
    padding:20px;
    box-shadow:0 2px 4px rgba(0,0,0,.06);
    margin-bottom:16px;
  }
  
  h2{
    margin:0 0 12px 0;
    font-size:18px;
    font-weight:600;
    color:var(--sap-text);
  }
  
  h3{
    margin:20px 0 10px 0;
    font-size:13px;
    color:var(--sap-accent);
    text-transform:uppercase;
    letter-spacing:.5px;
    font-weight:600;
  }
  
  .field{
    display:flex;
    flex-direction:column;
    gap:6px;
    margin-bottom:16px;
  }
  
  .field-row{
    display:flex;
    gap:16px;
    align-items:flex-end;
  }
  
  label{
    font-size:12px;
    color:var(--sap-muted);
    font-weight:500;
  }
  
  input[type="text"],
  input[type="number"],
  input[type="time"],
  select{
    padding:9px 12px;
    border:1px solid var(--sap-border);
    border-radius:6px;
    background:#fff;
    color:var(--sap-text);
    font-size:14px;
    transition:border-color 0.2s;
  }
  
  input[type="text"]:focus,
  input[type="number"]:focus,
  input[type="time"]:focus,
  select:focus{
    outline:none;
    border-color:var(--sap-accent);
  }
  
  input[type="number"]{
    text-align:right;
  }
  
  input[readonly]{
    background:#f8fafb;
    cursor:default;
  }
  
  .time-display{
    font-family:'Courier New', monospace;
    font-size:15px;
    font-weight:600;
    color:var(--sap-accent-2);
    padding:8px 12px;
    background:#f0f7ff;
    border:1px solid #cce0f5;
    border-radius:6px;
    min-width:100px;
    text-align:center;
  }
  
  .table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    margin-top:12px;
    border-radius:8px;
    overflow:hidden;
    box-shadow:0 2px 6px rgba(0,0,0,.1);
  }
  
  .table th,
  .table td{
    border-bottom:1px solid var(--sap-border);
    border-right:1px solid var(--sap-border);
    padding:10px;
    text-align:left;
    vertical-align:middle;
  }
  
  .table th:last-child,
  .table td:last-child{
    border-right:none;
  }
  
  .table tbody tr:last-child td{
    border-bottom:none;
  }
  
  .table th{
    background:linear-gradient(180deg, #f8fafb 0%, #f2f5f7 100%);
    font-weight:600;
    font-size:12px;
    color:var(--sap-text);
    text-transform:uppercase;
    letter-spacing:0.5px;
  }
  
  .table td{
    background:#fff;
    font-size:14px;
  }
  
  .table tbody tr:hover td{
    background:#f8fafb;
  }
  
  .table td.center,
  .table th.center{
    text-align:center;
  }
  
  .btn{
    padding:9px 14px;
    border-radius:6px;
    border:1px solid var(--sap-border);
    background:#fff;
    color:var(--sap-text);
    cursor:pointer;
    font-size:14px;
    font-weight:500;
    transition:all 0.2s;
  }
  
  .btn:hover{
    background:#f5f5f5;
    border-color:var(--sap-accent);
  }
  
  .btn.primary{
    background:var(--sap-accent);
    color:#fff;
    border-color:var(--sap-accent-2);
  }
  
  .btn.primary:hover{
    background:var(--sap-accent-2);
  }
  
  .btn.warning{
    background:var(--sap-warning);
    color:#fff;
    border-color:#d96a0c;
  }
  
  .btn.warning:hover{
    background:#d96a0c;
  }
  
  .btn.small{
    padding:6px 10px;
    font-size:12px;
  }
  
  .btn.danger{
    background:#fff;
    color:var(--sap-error);
    border-color:var(--sap-error);
  }
  
  .btn.danger:hover{
    background:#fee;
    color:var(--sap-error);
  }
  
  .btnbar{
    display:flex;
    gap:8px;
    align-items:center;
    margin-top:16px;
  }
  
  /* Timeline Styles */
  .timeline-container{
    background:#fff;
    border:1px solid var(--sap-border);
    border-radius:8px;
    padding:0;
    margin-top:16px;
    overflow-x:auto;
    position:relative;
  }
  
  .timeline-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:20px;
    padding-bottom:12px;
    border-bottom:1px solid var(--sap-border);
  }
  
  .timeline-info{
    display:flex;
    gap:30px;
  }
  
  .timeline-field{
    display:flex;
    flex-direction:column;
    gap:4px;
  }
  
  .timeline-field label{
    font-size:11px;
    color:var(--sap-muted);
  }
  
  .timeline-row{
    display:flex;
    align-items:center;
    height:20px;
    border-bottom:1px solid #e5e5e5;
    position:relative;
    transition:background 0.2s;
  }
  
  .timeline-row:hover{
    background:rgba(10,110,209,0.03);
  }
  
  .timeline-row:last-child{
    border-bottom:none;
  }
  
  .timeline-track{
    flex:0 0 auto;
    height:20px;
    position:relative;
    background-image:repeating-linear-gradient(
      90deg,
      transparent,
      transparent 59px,
      #e5e5e5 59px,
      #e5e5e5 60px
    );
    background-position:0 0;
    border-right:2px solid var(--sap-border);
  }
  
  .timeline-label{
    width:120px;
    padding:4px 8px;
    font-size:11px;
    border-right:1px solid #e5e5e5;
    display:flex;
    align-items:center;
    gap:4px;
  }
  
  .timeline-label-sequence{
    font-weight:700;
    color:var(--sap-accent);
    font-size:11px;
  }
  
  .timeline-label-phase{
    font-size:11px;
    color:var(--sap-text);
    font-weight:500;
  }
  
  .timeline-controls{
    display:flex;
    gap:0;
    align-items:center;
  }
  
  .control-field{
    display:flex;
    flex-direction:column;
    gap:3px;
    padding:8px 12px;
    border-right:1px solid #e5e5e5;
    background:linear-gradient(180deg, #fafbfc 0%, #f8f9fa 100%);
    transition:background 0.2s;
    align-items:center;
    width:90px;
  }
  
  .control-field:hover{
    background:linear-gradient(180deg, #f8f9fa 0%, #f5f6f7 100%);
  }
  
  .control-field label{
    font-size:10px;
    color:var(--sap-muted);
    text-transform:uppercase;
    font-weight:600;
  }
  
  .control-field input{
    padding:5px 8px;
    font-size:13px;
    border:1px solid #d5d5d5;
    border-radius:3px;
    background:#fff;
    transition:all 0.2s;
  }
  
  .control-field input:focus{
    border-color:var(--sap-accent);
    box-shadow:0 0 0 2px rgba(10,110,209,0.1);
  }
  
  .control-field input[type="text"]{
    width:70px;
    text-align:center;
  }
  
  .control-field-complete{
    width:80px;
    display:flex;
    align-items:center;
    justify-content:center;
    background:linear-gradient(180deg, #fafbfc 0%, #f8f9fa 100%);
    padding:8px 12px;
    border-right:none;
  }
  
  .timeline-checkbox{
    cursor:pointer;
    width:18px;
    height:18px;
    accent-color:var(--sap-success);
  }
  
  .timeline-checkbox:hover{
    transform:scale(1.1);
  }
  
  .timeline-block{
    position:absolute;
    height:12px;
    top:4px;
    border-radius:3px;
    cursor:move;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:0;
    color:#fff;
    font-size:11px;
    font-weight:600;
    transition:opacity 0.2s;
    box-shadow:0 1px 2px rgba(0,0,0,0.2);
    user-select:none;
  }
  
  .timeline-block:hover{
    opacity:0.9;
    z-index:10;
  }
  
  .timeline-block.dragging{
    opacity:0.7;
    z-index:20;
  }
  
  .timeline-block.completed{
    background-image:repeating-linear-gradient(
      45deg,
      transparent,
      transparent 10px,
      rgba(255,255,255,0.3) 10px,
      rgba(255,255,255,0.3) 20px
    );
    opacity:0.4;
    filter: grayscale(100%);
  }
  
  .timeline-scale{
    height:20px;
    position:relative;
    background:linear-gradient(180deg, #f8fafb 0%, #f2f5f7 100%);
    border-bottom:1px solid var(--sap-border);
    border-right:2px solid var(--sap-border);
    flex:0 0 auto;
  }

  .finish-line {
    position:absolute;
    top:0;
    bottom:0;
    width:2px;
    background:var(--sap-error);
    z-index:10;
  }
  .finish-line::before{
    content:'';
    position:absolute;
    top:-9px;
    left:-4px;
    width:12px;
    height:8px;
    background-image:
      linear-gradient(45deg, #000 25%, transparent 25%),
      linear-gradient(-45deg, #000 25%, transparent 25%),
      linear-gradient(45deg, transparent 75%, #000 75%),
      linear-gradient(-45deg, transparent 75%, #000 75%);
    background-size:4px 4px;
    background-position:0 0,0 2px,2px -2px,-2px 0;
  }
  
  .timeline-hour{
    position:absolute;
    font-size:10px;
    color:var(--sap-muted);
    top:4px;
    font-weight:600;
  }
  
  .timeline-hour:hover{
    color:var(--sap-accent);
  }
  
  .current-time-line{
    position:absolute;
    top:0;
    bottom:0;
    width:2px;
    background:red;
    z-index:9999;
    pointer-events:none;
  }
  
  .current-time-label{
    position:absolute;
    top:-22px;
    left:50%;
    transform:translateX(-50%);
    background:var(--sap-error);
    color:#fff;
    padding:2px 6px;
    border-radius:3px;
    font-size:10px;
    font-weight:600;
    white-space:nowrap;
  }
  
  /* Block Colors - Updated with Preparation */
  .block-export{background:#4CAF50;}
  .block-import{background:#2196F3;}
  .block-quality{background:#FF9800;}
  .block-qualitygate{background:#FF9800;}
  .block-conversion{background:#9C27B0;}
  .block-validation{background:#00BCD4;}
  .block-preparation{background:#795548;}
  
  /* Critical path indicators */
  .timeline-block.critical {
    box-shadow: 0 0 8px rgba(255, 0, 0, 0.6), 0 2px 4px rgba(0,0,0,0.3);
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0% { box-shadow: 0 0 8px rgba(255, 0, 0, 0.6), 0 2px 4px rgba(0,0,0,0.3); }
    50% { box-shadow: 0 0 16px rgba(255, 0, 0, 0.8), 0 2px 4px rgba(0,0,0,0.3); }
    100% { box-shadow: 0 0 8px rgba(255, 0, 0, 0.6), 0 2px 4px rgba(0,0,0,0.3); }
  }
  
  .critical-indicator {
    position: absolute;
    top: -8px;
    right: -8px;
    width: 16px;
    height: 16px;
    background: #ff0000;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 10px;
    font-weight: bold;
    z-index: 100;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }
  
  .table .critical-cell {
    text-align: center;
  }
  
  .critical-checkbox {
    cursor: pointer;
    width: 16px;
    height: 16px;
    accent-color: var(--sap-error);
  }
  
  .runblock-name{
    font-size:10px;
    color:var(--sap-muted);
    white-space:nowrap;
    pointer-events:none;
  }
  
  .legend{
    display:flex;
    gap:16px;
    margin-top:12px;
    padding-top:12px;
    border-top:1px solid var(--sap-border);
    font-size:12px;
    flex-wrap:wrap;
  }
  
  .legend-item{
    display:flex;
    align-items:center;
    gap:6px;
  }
  
  .legend-color{
    width:16px;
    height:16px;
    border-radius:3px;
  }
  
  .info-box{
    background:#f0f7ff;
    border:1px solid #cce0f5;
    border-radius:6px;
    padding:12px;
    margin-top:12px;
    font-size:12px;
    color:var(--sap-accent-2);
  }

  /* Layout adjustments */
  .timeline-container{
    display:flex;
    width:100%;
    overflow-x:hidden;
  }
  .timeline-scroll{
    flex:1 1 auto;
    overflow-x:auto;
    overflow-y:hidden;
    position:relative;
  }
  .timeline-right{
    flex:0 0 200px;
    display:flex;
    flex-direction:column;
    border-left:2px solid var(--sap-border);
  }
  
  .timeline-right-header{
    display:grid;
    grid-template-columns:70px 70px 60px;
    align-items:center;
    height:20px;
    background:linear-gradient(180deg, #f8fafb 0%, #f2f5f7 100%);
    border-bottom:1px solid var(--sap-border);
  }
  .timeline-right-header .header-cell{
    font-weight:600;
    font-size:10px;
    text-transform:uppercase;
    color:var(--sap-muted);
    display:flex;
    align-items:center;
    justify-content:center;
    border-right:1px solid #e5e5e5;
    padding:0;
    height:100%;
  }
  .timeline-right-header .header-cell:last-child{
    border-right:none;
  }

  #timelineControlsRows{
    display:flex;
    flex-direction:column;
  }
  .timeline-control-row{
    display:grid;
    grid-template-columns:70px 70px 60px;
    height:20px;
    border-bottom:1px solid #e5e5e5;
  }
  .timeline-control-cell{
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:12px;
    color:var(--sap-text);
    background:linear-gradient(180deg, #fafbfc 0%, #f8f9fa 100%);
    border-right:1px solid #e5e5e5;
  }
  .timeline-control-row .timeline-control-cell:last-child{
    border-right:none;
  }
  .timeline-control-cell input[type="text"]{
    width:100%;
    text-align:center;
    border:1px solid #d5d5d5;
    border-radius:3px;
    font-size:12px;
    padding:3px 4px;
  }
  .timeline-control-cell input[type="text"]:focus{
    border-color:var(--sap-accent);
    box-shadow:0 0 0 2px rgba(10,110,209,0.1);
  }
  .timeline-control-cell input[type="checkbox"]{
    cursor:pointer;
    width:16px;
    height:16px;
    accent-color:var(--sap-success);
  }

  .hidden{
    display:none;
  }
  
  .timeline-table-header{
    display:flex;
    align-items:center;
    height:30px;
    background:#f8fafb;
    border-bottom:2px solid var(--sap-accent);
  }
  
  .header-cell{
    padding:8px 12px;
    font-size:10px;
    font-weight:600;
    text-transform:uppercase;
    color:var(--sap-muted);
    border-right:1px solid #e5e5e5;
  }

  .btn.success{
    background:var(--sap-success);
    color:#fff;
    border-color:#0b6d34;
  }
  .btn.success:hover{
    background:#0b6d34;
  }

  .quality-diamond{
    position:absolute;
    width:14px;
    height:14px;
    background:#FF9800;
    transform:rotate(45deg);
    top:50%;
    margin-top:-7px;
    border-radius:2px;
    box-shadow:0 1px 2px rgba(0,0,0,0.2);
  }

  .legend-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-top:12px;
    padding-top:12px;
    border-top:1px solid var(--sap-border);
  }
  .legend-row .legend{
    margin:0;
    padding:0;
    border-top:none;
  }

  @media print{
    body *{ visibility:hidden !important; }
    #progressPanel, #progressPanel *{ visibility:visible !important; }
    #progressPanel{ position:relative; }
    #progressPanel #reportBtn{ display:none !important; }
    .timeline-container{ overflow:visible !important; }
  }

  .timeline-footer{
    display:flex;
    justify-content: space-between;
    align-items:center;
    gap:12px;
    margin-top:12px;
    padding-top:6px;
    border-top: 1px dashed var(--sap-border, #ccc);
  }
  .timeline-footer .legend{ margin:0; }
  .timeline-footer #reportBtn{ margin-left:auto !important; align-self:center; }

  :root{
    --tl-header-height: 24px;
    --tl-header-size: 14px;
    --tl-header-weight: 600;
  }
  .timeline-right-header{
    height: var(--tl-header-height) !important;
    display:grid;
    grid-template-columns: 72px 72px 64px;
    align-items:center;
    white-space:nowrap;
    font-size: var(--tl-header-size) !important;
    font-weight: var(--tl-header-weight) !important;
  }
  .timeline-right-header .header-cell{
    line-height: var(--tl-header-height) !important;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }
  .timeline-scale{
    height: var(--tl-header-height) !important;
    line-height: var(--tl-header-height) !important;
    white-space:nowrap;
    font-size: var(--tl-header-size) !important;
    font-weight: var(--tl-header-weight) !important;
  }
  .timeline-control-row{ height: 24px !important; }
  .timeline-control-cell{ display:flex; align-items:center; height:24px; }
</style>

  <script
    src="https://res.cdn.office.net/teams-js/2.0.0/js/MicrosoftTeams.min.js"
    integrity="sha384-QtTBFeFlfRDZBfwHJHYQp7MdLJ2C3sfAEB1Qpy+YblvjavBye+q87TELpTnvlXw4"
    crossorigin="anonymous">
  </script>
</head>
<body>
  <div class="app-header">
    <div class="brand">
      <svg viewBox="0 0 100 28" xmlns="http://www.w3.org/2000/svg">
        <rect width="100" height="28" fill="#fff" rx="4"/>
        <text x="50" y="20" text-anchor="middle" font-family="Arial, sans-serif" font-size="18" font-weight="bold" fill="#0a6ed1">SNP</text>
      </svg>
      <h1>Technical Downtime Tracking</h1>
    </div>
    <div class="status-display">
      <div class="status-item">
        <span class="status-label">Current Time</span>
        <span class="status-value" id="currentTime">--:--:--</span>
      </div>
      <div class="status-item">
        <span class="status-label">Status</span>
        <span class="status-value" id="statusText" style="color:var(--sap-warning);">Not Started</span>
      </div>
    </div>
  </div>

  <div class="content">
    <!-- Customer Information -->
    <div class="panel" style="margin-bottom:16px;padding:16px;">
      <div class="field-row">
        <div class="field" style="flex:1;">
          <label>Customer Name *</label>
          <input type="text" id="customerName" placeholder="Enter customer name" value="ACME Corporation">
        </div>
        <div class="field" style="flex:1;">
          <label>Transform Cycle</label>
          <select id="transformCycle">
            <option value="Test Migration">Test Migration</option>
            <option value="Go Live Simulation">Go Live Simulation</option>
            <option value="Go-Live">Go-Live</option>
          </select>
        </div>
      </div>
    </div>
    
    <!-- Progress Tracking Section -->
    <div id="progressPanel" class="panel">
      <h2>Progress Tracking Window</h2>
      
      <div class="timeline-header">
        <div class="timeline-info">
          <div class="timeline-field">
            <label>Technical Downtime Duration</label>
            <input type="number" id="downtimeDuration" min="1" max="168" value="24" onchange="updateTimeline()" style="width:80px;">
          </div>
          <div class="timeline-field">
            <label>Start Time</label>
            <div class="time-display" id="startTimeDisplay">--:--:--</div>
          </div>
          <div class="timeline-field">
            <label>Current Duration</label>
            <div class="time-display" id="currentDurationDisplay">00:00:00</div>
          </div>
          <div class="timeline-field">
            <label>Estimated End Time</label>
            <div class="time-display" id="endTimeDisplay">--:--:--</div>
          </div>
        </div>
        <div id="downtimeControls">
          <button class="btn primary" id="startDowntimeBtn" onclick="startDowntime()">Start Downtime</button>
        </div>
      </div>

      <div class="timeline-container">
        <div class="timeline-scroll">
          <div class="timeline-table-header">
            <div class="timeline-scale" id="timelineScale">
              <!-- Hour markers will be generated here -->
            </div>
          </div>
          <div id="timelineRows">
            <!-- Timeline track rows will be generated here -->
          </div>
          <div id="finishLine" class="finish-line"></div>
          <div class="current-time-line" id="currentTimeLine" style="display:none;">
            <div class="current-time-label" id="currentTimeLabel">00:00:00</div>
          </div>
        </div>
        <div class="timeline-right">
          <div class="timeline-right-header">
            <div class="header-cell start-header">START</div>
            <div class="header-cell duration-header">DURATION</div>
            <div class="header-cell complete-header">COMPLETE</div>
          </div>
          <div id="timelineControlsRows">
            <!-- Timeline control rows will be generated here -->
          </div>
        </div>
      </div>
      
      <div class="legend">
        <div class="legend-item">
          <div class="legend-color block-preparation"></div>
          <span>Preparation</span>
        </div>
        <div class="legend-item">
          <div class="legend-color block-export"></div>
          <span>Export</span>
        </div>
        <div class="legend-item">
          <div class="legend-color block-import"></div>
          <span>Import</span>
        </div>
        <div class="legend-item">
          <div class="legend-color block-quality"></div>
          <span>Quality Gate</span>
        </div>
        <div class="legend-item">
          <div class="legend-color block-conversion"></div>
          <span>Conversion</span>
        </div>
        <div class="legend-item">
          <div class="legend-color block-validation"></div>
          <span>Validation</span>
        </div>
        <div class="legend-item" style="margin-left:auto;">
          <div style="width:16px;height:16px;background:#ff0000;border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-size:10px;font-weight:bold;">!</div>
          <span>Critical Path</span>
        </div>
      
        <button class="btn success" id="reportBtn" onclick="generateReport()" style="margin-left:auto">Report</button>
      </div>
    </div>

    <!-- Model Parameters Section -->
    <div class="panel">
      <h2>Model Parameters</h2>

      <h3>Runbook Configuration</h3>
      <table class="table" id="runbookTable">
        <thead>
          <tr>
            <th style="width:80px;">Sequence</th>
            <th style="width:130px;">Strategy</th>
            <th style="width:130px;">Phase</th>
            <th style="width:160px;">Runblock</th>
            <th style="width:200px;">Responsibility</th>
            <th style="width:60px;text-align:center;">Critical</th>
            <th style="width:80px;text-align:center;">Actions</th>
          </tr>
        </thead>
        <tbody id="runbookBody">
          <!-- Dynamic rows will be added here -->
        </tbody>
      </table>
      
      <div class="btnbar">
        <button class="btn primary" onclick="addRunbookRow()">+ Add Line</button>
        <button class="btn" onclick="clearRunbook()">Clear All</button>
        <div style="margin-left:auto;">
          <input type="file" id="uploadFile" accept=".csv" class="hidden" onchange="uploadExcel(event)">
          <button class="btn" onclick="downloadExcel()">📥 Download</button>
          <button class="btn" onclick="document.getElementById('uploadFile').click()">📤 Upload</button>
        </div>
      </div>
      
      <div class="info-box">
        <strong>Instructions:</strong><br>
        • Enter sequences 1-30 to define execution order<br>
        • Select strategy and phase for each runblock<br>
        • Enter runblock name for identification<br>
        • Schedule time shows hours:minutes after downtime start<br>
        • Duration controls the length of each runblock in the timeline
      </div>
    </div>
  </div>

<script>
// Initialize Microsoft Teams if running inside Teams
if (typeof microsoftTeams !== 'undefined' && microsoftTeams.app && typeof microsoftTeams.app.initialize === 'function') {
  const validOrigins = ['https://snpcom.sharepoint.com'];
  microsoftTeams.app.initialize(validOrigins).catch(() => {
    console.warn('Teams initialization failed or not running inside Teams');
  });
}

// Global state
const AppState = {
  runbooks: [],
  downtimeStarted: false,
  downtimeStartTime: null,
  downtimeDuration: 24,
  downtimePaused: false,
  pausedDuration: 0,
  pauseStartTime: null,
  currentDraggedBlock: null,
  dragOffset: 0
};

// Strategy and Phase options - UPDATED with Preparation, Collector, and NZD
const STRATEGIES = ['Preparation', 'Export', 'Import', 'Quality Gate', 'Conversion', 'Validation'];
const PHASES = ['Tables', 'Delta', 'Checkpoint', 'Finance', 'Logistics', 'PCA Tool', 'MPP', 'Support', 'Collector', 'NZD'];

// Reset everything to default state
function resetApplication() {
  AppState.runbooks = [];
  AppState.downtimeStarted = false;
  AppState.downtimeStartTime = null;
  AppState.downtimeDuration = 24;
  AppState.downtimePaused = false;
  AppState.pausedDuration = 0;
  AppState.pauseStartTime = null;
  AppState.currentDraggedBlock = null;
  AppState.dragOffset = 0;
  
  document.getElementById('downtimeDuration').value = 24;
  document.getElementById('startTimeDisplay').textContent = '--:--:--';
  document.getElementById('endTimeDisplay').textContent = '--:--:--';
  document.getElementById('currentDurationDisplay').textContent = '00:00:00';
  document.getElementById('statusText').textContent = 'Not Started';
  document.getElementById('statusText').style.color = 'var(--sap-warning)';
  
  document.getElementById('downtimeControls').innerHTML = `
    <button class="btn primary" id="startDowntimeBtn" onclick="startDowntime()">Start Downtime</button>
  `;
  
  const currentLine = document.getElementById('currentTimeLine');
  if (currentLine) currentLine.style.display = 'none';
  
  document.getElementById('runbookBody').innerHTML = '';
  document.getElementById('timelineRows').innerHTML = '';
  
  // Don't add default empty rows
  
  alert('Application has been reset. All data cleared.');
}

// Initialize application
document.addEventListener('DOMContentLoaded', function() {
  initializeApp();
  updateClock();
  setInterval(updateClock, 1000);
});

function initializeApp() {
  // Don't add any initial rows - user will add as needed
  updateTimeline();
}

function updateClock() {
  const now = new Date();
  document.getElementById('currentTime').textContent = 
    now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
  
  if (AppState.downtimeStarted && AppState.downtimeStartTime && !AppState.downtimePaused) {
    updateDuration();
    updateProgressIndicators();
  }
}

function updateDuration() {
  if (!AppState.downtimeStartTime) return;
  
  const now = new Date();
  const elapsed = now - AppState.downtimeStartTime - AppState.pausedDuration;
  const hours = Math.floor(elapsed / 3600000);
  const minutes = Math.floor((elapsed % 3600000) / 60000);
  const seconds = Math.floor((elapsed % 60000) / 1000);
  
  const durationDisplay = document.getElementById('currentDurationDisplay');
  durationDisplay.textContent = 
    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}

function addRunbookRow() {
  const runbook = {
    id: Date.now() + Math.random(),
    sequence: AppState.runbooks.length + 1,
    strategy: STRATEGIES[0], // 'Preparation'
    phase: PHASES[0], // 'Tables'
    runblock: '', // Empty by default
    responsibility: '',
    critical: false, // New field for critical path
    scheduleHours: 0,
    scheduleMinutes: 0,
    durationHours: 1,
    durationMinutes: 0,
    completed: false,
    position: 0
  };
  
  AppState.runbooks.push(runbook);
  renderRunbookTable();
  updateTimeline();
}

function renderRunbookTable() {
  const tbody = document.getElementById('runbookBody');
  tbody.innerHTML = '';
  
  AppState.runbooks.sort((a, b) => a.sequence - b.sequence);
  
  AppState.runbooks.forEach(runbook => {
    const row = document.createElement('tr');
    const editingDisabled = (AppState.downtimeStarted && !AppState.downtimePaused) ? 'disabled' : '';
    row.innerHTML = `
      <td>
        <input type="number" min="1" max="30" value="${runbook.sequence}" 
               style="width:60px;" onchange="updateSequence(${runbook.id}, this.value)" ${editingDisabled}>
      </td>
      <td>
        <select onchange="updateStrategy(${runbook.id}, this.value)" ${editingDisabled}>
          ${STRATEGIES.map(s => `<option value="${s}" ${runbook.strategy === s ? 'selected' : ''}>${s}</option>`).join('')}
        </select>
      </td>
      <td>
        <select onchange="updatePhase(${runbook.id}, this.value)" ${editingDisabled}>
          ${PHASES.map(p => `<option value="${p}" ${runbook.phase === p ? 'selected' : ''}>${p}</option>`).join('')}
        </select>
      </td>
      <td>
        <input type="text" value="${runbook.runblock}" placeholder="Enter runblock name" 
               maxlength="50" style="width:100%;"
               onchange="updateRunblock(${runbook.id}, this.value)" ${editingDisabled}>
      </td>
      <td>
        <input type="text" value="${runbook.responsibility || ''}" placeholder="Enter responsibility" 
               maxlength="40" style="width:100%;"
               onchange="updateResponsibility(${runbook.id}, this.value)" ${editingDisabled}>
      </td>
      <td class="critical-cell center">
        <input type="checkbox" class="critical-checkbox" 
               ${runbook.critical ? 'checked' : ''} 
               onchange="updateCritical(${runbook.id}, this.checked)" ${editingDisabled}>
      </td>
      <td class="center">
        <button class="btn small danger" onclick="removeRunbook(${runbook.id})" ${editingDisabled}>Remove</button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function updateCritical(id, value) {
  const runbook = AppState.runbooks.find(r => r.id === id);
  if (runbook) {
    runbook.critical = value;
    updateTimeline();
  }
}

function updateSequence(id, value) {
  const runbook = AppState.runbooks.find(r => r.id === id);
  if (runbook) {
    const newSequence = parseInt(value) || 1;
    const oldSequence = runbook.sequence;
    runbook.sequence = newSequence;
    
    const sameSequence = AppState.runbooks.filter(r => r.sequence === newSequence && r.id !== id);
    if (sameSequence.length > 0) {
      runbook.scheduleHours = sameSequence[0].scheduleHours;
      runbook.scheduleMinutes = sameSequence[0].scheduleMinutes;
    }
    
    renderRunbookTable();
    updateTimeline();
  }
}

function updateStrategy(id, value) {
  const runbook = AppState.runbooks.find(r => r.id === id);
  if (runbook) {
    runbook.strategy = value;
    updateTimeline();
  }
}

function updatePhase(id, value) {
  const runbook = AppState.runbooks.find(r => r.id === id);
  if (runbook) {
    runbook._originalPhase = value;
    
    if (PHASES.includes(value)) {
      runbook.phase = value;
    }
    updateTimeline();
  }
}

function updateRunblock(id, value) {
  const runbook = AppState.runbooks.find(r => r.id === id);
  if (runbook) {
    runbook.runblock = value;
    updateTimeline();
  }
}

function updateResponsibility(id, value) {
  const runbook = AppState.runbooks.find(r => r.id === id);
  if (runbook) {
    runbook.responsibility = value;
  }
}

function removeRunbook(id) {
  AppState.runbooks = AppState.runbooks.filter(r => r.id !== id);
  renderRunbookTable();
  updateTimeline();
}

function clearRunbook() {
  if (confirm('Are you sure you want to clear all runbook entries?')) {
    AppState.runbooks = [];
    renderRunbookTable();
    updateTimeline();
    document.getElementById('timelineRows').innerHTML = '';
  }
}

function updateTimeline() {
  const duration = parseInt(document.getElementById('downtimeDuration').value) || 24;
  AppState.downtimeDuration = duration;
  
  generateTimeScale(duration);
  generateTimelineRows();

  const finishLine = document.getElementById('finishLine');
  if (finishLine) {
    const pixelsPerHour = 60;
    const left = AppState.downtimeDuration * pixelsPerHour;
    finishLine.style.left = `${left}px`;
    finishLine.style.display = 'block';
  }
}

function generateTimeScale(hours) {
  const scale = document.getElementById('timelineScale');
  scale.innerHTML = '';
  
  const pixelsPerHour = 60;
  const totalWidth = hours * pixelsPerHour;
  
  scale.style.width = `${totalWidth}px`;
  
  for (let h = 0; h <= hours; h++) {
    const marker = document.createElement('div');
    marker.className = 'timeline-hour';
    marker.style.left = `${h * pixelsPerHour}px`;
    marker.textContent = `${h}h`;
    scale.appendChild(marker);
  }
}

function generateTimelineRows() {
  const trackContainer = document.getElementById('timelineRows');
  const controlsContainer = document.getElementById('timelineControlsRows');
  if (trackContainer) trackContainer.innerHTML = '';
  if (controlsContainer) controlsContainer.innerHTML = '';
  
  // IMPORTANT: Only show rows with non-empty runblock names
  const sortedRunbooks = [...AppState.runbooks]
    .sort((a, b) => a.sequence - b.sequence)
    .filter(rb => (rb && (rb.runblock || '').trim().length > 0));

  sortedRunbooks.forEach((runbook, index) => {
    const trackRow = createTimelineRow(runbook, index);
    if (trackContainer) trackContainer.appendChild(trackRow);
    const controlRow = createTimelineControlRow(runbook);
    if (controlsContainer) controlsContainer.appendChild(controlRow);
  });
}

function createTimelineRow(runbook, index) {
  const row = document.createElement('div');
  row.className = 'timeline-row';
  
  // Add visual indicator for critical path items
  if (runbook.critical) {
    row.style.borderLeft = '3px solid #ff0000';
    row.style.background = 'linear-gradient(90deg, rgba(255,0,0,0.05) 0%, transparent 10%)';
  }
  
  const track = document.createElement('div');
  track.className = 'timeline-track';
  track.dataset.runbookId = runbook.id;
  
  const pixelsPerHour = 60;
  const totalWidth = AppState.downtimeDuration * pixelsPerHour;
  track.style.width = `${totalWidth}px`;

  const isQualityGate = (runbook.strategy === 'Quality Gate');
  const startPos = runbook.scheduleHours + (runbook.scheduleMinutes / 60);
  const duration = runbook.durationHours + (runbook.durationMinutes / 60);
  const startX = startPos * pixelsPerHour;

  if (isQualityGate) {
    const diamond = document.createElement('div');
    diamond.className = 'quality-diamond';
    diamond.style.left = `${Math.max(0, startX - 7)}px`;
    if (runbook.completed) {
      diamond.style.opacity = '0.5';
      diamond.style.filter = 'grayscale(100%)';
    }
    track.appendChild(diamond);

    if (runbook.runblock) {
      const nameLabel = document.createElement('div');
      nameLabel.className = 'runblock-name';
      nameLabel.textContent = runbook.runblock;
      nameLabel.style.position = 'absolute';
      nameLabel.style.top = '50%';
      nameLabel.style.transform = 'translateY(-50%)';
      track.appendChild(nameLabel);
      requestAnimationFrame(() => {
        const w = nameLabel.offsetWidth || 0;
        nameLabel.style.left = `${Math.max(0, startX - w - 8)}px`;
      });
    }
  } else {
    const block = createTimelineBlock(runbook);
    track.appendChild(block);
    if (runbook.runblock) {
      const nameLabel = document.createElement('div');
      nameLabel.className = 'runblock-name';
      nameLabel.textContent = runbook.runblock;
      nameLabel.title = runbook.runblock;
      nameLabel.style.position = 'absolute';
      nameLabel.style.top = '50%';
      nameLabel.style.transform = 'translateY(-50%)';
      const blockWidth = Math.max(60, duration * pixelsPerHour - 4);
      nameLabel.style.left = `${startX + blockWidth + 6}px`;
      track.appendChild(nameLabel);
    }
  }

  row.appendChild(track);
  track.addEventListener('dragover', handleDragOver);
  track.addEventListener('drop', handleDrop);
  return row;
}

function createTimelineControlRow(runbook) {
  const row = document.createElement('div');
  row.className = 'timeline-control-row';

  const startCell = document.createElement('div');
  startCell.className = 'timeline-control-cell start-cell';
  if (runbook.completed) {
    const span = document.createElement('span');
    span.textContent = `${String(runbook.scheduleHours).padStart(2,'0')}:${String(runbook.scheduleMinutes).padStart(2,'0')}`;
    startCell.appendChild(span);
  } else {
    const input = document.createElement('input');
    input.type = 'text';
    input.pattern = '[0-9]{1,3}:[0-9]{2}';
    input.placeholder = 'HH:MM';
    input.value = `${String(runbook.scheduleHours).padStart(2,'0')}:${String(runbook.scheduleMinutes).padStart(2,'0')}`;
    input.onchange = function() { updateScheduleTime(runbook.id, this.value); };
    startCell.appendChild(input);
  }
  row.appendChild(startCell);

  const durationCell = document.createElement('div');
  durationCell.className = 'timeline-control-cell duration-cell';
  if (runbook.completed) {
    const span = document.createElement('span');
    span.textContent = `${String(runbook.durationHours).padStart(2,'0')}:${String(runbook.durationMinutes).padStart(2,'0')}`;
    durationCell.appendChild(span);
  } else {
    const input = document.createElement('input');
    input.type = 'text';
    input.pattern = '[0-9]{1,3}:[0-9]{2}';
    input.placeholder = 'HH:MM';
    input.value = `${String(runbook.durationHours).padStart(2,'0')}:${String(runbook.durationMinutes).padStart(2,'0')}`;
    input.onchange = function() { updateDurationTime(runbook.id, this.value); };
    durationCell.appendChild(input);
  }
  row.appendChild(durationCell);

  const completeCell = document.createElement('div');
  completeCell.className = 'timeline-control-cell complete-cell';
  const checkbox = document.createElement('input');
  checkbox.type = 'checkbox';
  checkbox.className = 'timeline-checkbox';
  checkbox.checked = runbook.completed;
  checkbox.title = 'Mark as completed';
  checkbox.disabled = !(AppState.downtimeStarted && !AppState.downtimePaused);
  checkbox.onchange = function() { toggleCompleted(runbook.id, this.checked); };
  completeCell.appendChild(checkbox);
  row.appendChild(completeCell);
  return row;
}

function createTimelineBlock(runbook) {
  const block = document.createElement('div');
  const strategyClass = runbook.strategy.toLowerCase().replace(/\s+/g, '');
  block.className = `timeline-block block-${strategyClass}`;
  block.dataset.runbookId = runbook.id;
  
  // Add critical class if marked as critical
  if (runbook.critical) {
    block.classList.add('critical');
  }
  
  if (runbook.completed) {
    block.classList.add('completed');
    block.draggable = false;
  } else {
    block.draggable = true;
  }
  
  const pixelsPerHour = 60;
  const position = runbook.scheduleHours + (runbook.scheduleMinutes / 60);
  const duration = runbook.durationHours + (runbook.durationMinutes / 60);
  
  block.style.left = `${position * pixelsPerHour}px`;
  block.style.width = `${Math.max(60, duration * pixelsPerHour - 4)}px`;
  
  const blockLabel = document.createElement('div');
  blockLabel.className = 'block-label';
  blockLabel.textContent = `#${runbook.sequence} ${runbook.phase}`;
  block.appendChild(blockLabel);
  
  // Add critical indicator if marked as critical
  if (runbook.critical) {
    const indicator = document.createElement('div');
    indicator.className = 'critical-indicator';
    indicator.textContent = '!';
    indicator.title = 'Critical Path Item';
    block.appendChild(indicator);
  }
  
  if (!runbook.completed) {
    block.addEventListener('dragstart', handleDragStart);
    block.addEventListener('dragend', handleDragEnd);
  }
  
  return block;
}

function handleDragStart(e) {
  e.dataTransfer.effectAllowed = 'move';
  e.target.classList.add('dragging');
  AppState.currentDraggedBlock = e.target;
  
  const rect = e.target.getBoundingClientRect();
  const trackRect = e.target.parentElement.getBoundingClientRect();
  AppState.dragOffset = e.clientX - rect.left;
}

function handleDragEnd(e) {
  e.target.classList.remove('dragging');
  AppState.currentDraggedBlock = null;
  AppState.dragOffset = 0;
}

function handleDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  
  if (AppState.currentDraggedBlock && e.currentTarget.classList.contains('timeline-track')) {
    const track = e.currentTarget;
    const rect = track.getBoundingClientRect();
    const x = e.clientX - rect.left - (AppState.dragOffset || 0);
    const pixelsPerHour = 60;
    
    const position = Math.max(0, x / pixelsPerHour);
    const runbookId = parseFloat(AppState.currentDraggedBlock.dataset.runbookId);
    const runbook = AppState.runbooks.find(r => r.id === runbookId);
    
    if (runbook) {
      const duration = runbook.durationHours + (runbook.durationMinutes / 60);
      const maxPosition = AppState.downtimeDuration - duration;
      const validPosition = Math.min(position, maxPosition);
      
      AppState.currentDraggedBlock.style.left = `${validPosition * pixelsPerHour}px`;
    }
  }
}

function handleDrop(e) {
  e.preventDefault();
  
  if (!AppState.currentDraggedBlock) return;
  
  const track = e.currentTarget;
  const rect = track.getBoundingClientRect();
  const x = e.clientX - rect.left - (AppState.dragOffset || 0);
  const pixelsPerHour = 60;
  const newPosition = Math.max(0, x / pixelsPerHour);
  
  const runbookId = parseFloat(AppState.currentDraggedBlock.dataset.runbookId);
  const runbook = AppState.runbooks.find(r => r.id === runbookId);
  
  if (runbook) {
    const duration = runbook.durationHours + (runbook.durationMinutes / 60);
    
    const maxPosition = AppState.downtimeDuration - duration;
    const finalPosition = Math.min(newPosition, maxPosition);
    
    const snappedPosition = Math.round(finalPosition * 4) / 4;
    
    const newHours = Math.floor(snappedPosition);
    const newMinutes = Math.round((snappedPosition % 1) * 60);
    
    runbook.scheduleHours = newHours;
    runbook.scheduleMinutes = newMinutes;
    
    const sameSequence = AppState.runbooks.filter(r => r.sequence === runbook.sequence);
    sameSequence.forEach(r => {
      r.scheduleHours = newHours;
      r.scheduleMinutes = newMinutes;
    });
    
    updateTimeline();
  }
}

function updateScheduleTime(id, value) {
  const runbook = AppState.runbooks.find(r => r.id === id);
  if (runbook) {
    const parts = value.split(':');
    const hours = parseInt(parts[0]) || 0;
    const minutes = parseInt(parts[1]) || 0;
    
    runbook.scheduleHours = hours;
    runbook.scheduleMinutes = minutes;
    
    const sameSequence = AppState.runbooks.filter(r => r.sequence === runbook.sequence);
    sameSequence.forEach(r => {
      r.scheduleHours = hours;
      r.scheduleMinutes = minutes;
    });
    
    updateTimeline();
  }
}

function updateDurationTime(id, value) {
  const runbook = AppState.runbooks.find(r => r.id === id);
  if (runbook) {
    const parts = value.split(':');
    const hours = parseInt(parts[0]) || 0;
    const minutes = parseInt(parts[1]) || 0;
    
    runbook.durationHours = hours;
    runbook.durationMinutes = minutes;
    updateTimeline();
  }
}

function toggleCompleted(id, checked) {
  const runbook = AppState.runbooks.find(r => r.id === id);
  if (runbook) {
    runbook.completed = checked;
    updateTimeline();
  }
}

function startDowntime() {
  { const l=document.getElementById('currentTimeLine'); if(l) l.style.display='block'; }

  AppState.downtimeStarted = true;
  AppState.downtimeStartTime = new Date();
  AppState.pausedDuration = 0;
  
  const downtimeDuration = parseInt(document.getElementById('downtimeDuration').value) || 24;
  AppState.downtimeDuration = downtimeDuration;
  
  const startTimeStr = AppState.downtimeStartTime.toLocaleTimeString('en-US', 
    { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
  
  const endTime = new Date(AppState.downtimeStartTime.getTime() + downtimeDuration * 3600000);
  const endTimeStr = endTime.toLocaleTimeString('en-US', 
    { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
  
  document.getElementById('startTimeDisplay').textContent = startTimeStr;
  document.getElementById('endTimeDisplay').textContent = endTimeStr;
  document.getElementById('statusText').textContent = 'In Progress';
  document.getElementById('statusText').style.color = 'var(--sap-error)';
  
  document.getElementById('downtimeControls').innerHTML = `
    <button class="btn warning" onclick="pauseDowntime()">⏸ Pause</button>
    <button class="btn danger" onclick="stopDowntime()">⏹ Stop</button>
  `;
  
  const currentLine = document.getElementById('currentTimeLine');
  currentLine.style.display = 'block';
  currentLine.style.left = '0px';
  
  updateProgressIndicators();
  updateTimeline();
  renderRunbookTable();
}

function pauseDowntime() {
  if (!AppState.downtimePaused) {
    AppState.downtimePaused = true;
    AppState.pauseStartTime = new Date();
    document.getElementById('statusText').textContent = 'Paused';
    document.getElementById('statusText').style.color = 'var(--sap-warning)';
    
    document.getElementById('downtimeControls').innerHTML = `
      <button class="btn primary" onclick="resumeDowntime()">▶ Resume</button>
      <button class="btn danger" onclick="stopDowntime()">⏹ Stop</button>
    `;

    updateTimeline();
    renderRunbookTable();
  }
}

function resumeDowntime() {
  { const l=document.getElementById('currentTimeLine'); if(l) l.style.display='block'; }

  if (AppState.downtimePaused) {
    const pauseDuration = new Date() - AppState.pauseStartTime;
    AppState.pausedDuration += pauseDuration;
    AppState.downtimePaused = false;
    AppState.pauseStartTime = null;
    
    document.getElementById('statusText').textContent = 'In Progress';
    document.getElementById('statusText').style.color = 'var(--sap-error)';
    
    document.getElementById('downtimeControls').innerHTML = `
      <button class="btn warning" onclick="pauseDowntime()">⏸ Pause</button>
      <button class="btn danger" onclick="stopDowntime()">⏹ Stop</button>
    `;

    updateTimeline();
    renderRunbookTable();
  }
}

function stopDowntime() {
  if (confirm('Are you sure you want to stop the downtime tracking? All times will be reset.')) {
    AppState.downtimeStarted = false;
    AppState.downtimeStartTime = null;
    AppState.downtimePaused = false;
    AppState.pausedDuration = 0;
    AppState.pauseStartTime = null;
    
    document.getElementById('startTimeDisplay').textContent = '--:--:--';
    document.getElementById('endTimeDisplay').textContent = '--:--:--';
    document.getElementById('currentDurationDisplay').textContent = '00:00:00';
    document.getElementById('statusText').textContent = 'Not Started';
    document.getElementById('statusText').style.color = 'var(--sap-warning)';
    
    document.getElementById('downtimeControls').innerHTML = `
      <button class="btn primary" id="startDowntimeBtn" onclick="startDowntime()">Start Downtime</button>
    `;
    
    document.getElementById('currentTimeLine').style.display = 'none';
    
    updateTimeline();
    renderRunbookTable();
  }
}

function updateProgressIndicators() {
  if (!AppState.downtimeStarted || !AppState.downtimeStartTime) return;
  
  const now = new Date();
  const elapsedMs = now - AppState.downtimeStartTime - AppState.pausedDuration;
  const elapsed = elapsedMs / 3600000;
  
  const pixelsPerHour = 60;
  const linePosition = Math.min(elapsed * pixelsPerHour, AppState.downtimeDuration * pixelsPerHour);
  const currentLine = document.getElementById('currentTimeLine');
  currentLine.style.left = `${linePosition}px`;
  currentLine.style.display = 'block';
  
  const totalSeconds = Math.floor(elapsedMs / 1000);
  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = totalSeconds % 60;
  
  const timeStr = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
  document.getElementById('currentTimeLabel').textContent = timeStr;
    
  if (elapsed >= AppState.downtimeDuration) {
    document.getElementById('statusText').textContent = 'Completed';
    document.getElementById('statusText').style.color = 'var(--sap-accent)';
    
    updateTimeline();
  }
}

function downloadExcel() {
  const data = AppState.runbooks.map(r => ({
    Sequence: r.sequence,
    Strategy: r.strategy,
    Phase: r.phase,
    Runblock: r.runblock,
    Responsibility: r.responsibility || '',
    Critical: r.critical ? 'Yes' : 'No',
    ScheduleTime: `${String(r.scheduleHours).padStart(2,'0')}:${String(r.scheduleMinutes).padStart(2,'0')}`,
    Duration: `${String(r.durationHours).padStart(2,'0')}:${String(r.durationMinutes).padStart(2,'0')}`,
    Completed: r.completed ? 'Yes' : 'No'
  }));
  
  const headers = Object.keys(data[0] || {});
  const csvContent = [
    headers.join(','),
    ...data.map(row => headers.map(header => `"${row[header] || ''}"`).join(','))
  ].join('\n');
  
  const customerName = document.getElementById('customerName').value || 'customer';
  const safeCustomerName = customerName.replace(/[^a-zA-Z0-9]/g, '_');
  const dateStr = new Date().toISOString().slice(0,10);
  
  const blob = new Blob([csvContent], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${safeCustomerName}_downtime_runbook_${dateStr}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function uploadExcel(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const text = e.target.result;
      const lines = text.split('\n');
      const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
      
      AppState.runbooks = [];
      
      for (let i = 1; i < lines.length; i++) {
        if (lines[i].trim()) {
          const values = lines[i].match(/(".*?"|[^,]+)/g).map(v => v.replace(/"/g, '').trim());
          
          const scheduleTime = values[headers.indexOf('ScheduleTime')] || '00:00';
          const [scheduleHours, scheduleMinutes] = scheduleTime.split(':').map(Number);
          
          const duration = values[headers.indexOf('Duration')] || '01:00';
          const [durationHours, durationMinutes] = duration.split(':').map(Number);
          
          const runbook = {
            id: Date.now() + Math.random() + i,
            sequence: parseInt(values[headers.indexOf('Sequence')]) || i,
            strategy: values[headers.indexOf('Strategy')] || STRATEGIES[0],
            phase: values[headers.indexOf('Phase')] || PHASES[0],
            runblock: values[headers.indexOf('Runblock')] || '',
            responsibility: values[headers.indexOf('Responsibility')] || '',
            critical: values[headers.indexOf('Critical')] === 'Yes',
            scheduleHours: scheduleHours || 0,
            scheduleMinutes: scheduleMinutes || 0,
            durationHours: durationHours || 1,
            durationMinutes: durationMinutes || 0,
            completed: values[headers.indexOf('Completed')] === 'Yes'
          };
          
          AppState.runbooks.push(runbook);
        }
      }
      
      renderRunbookTable();
      updateTimeline();
      alert('Configuration loaded successfully!');
      
    } catch (error) {
      alert('Error loading file. Please check the format.');
      console.error(error);
    }
  };
  reader.readAsText(file);
  
  event.target.value = '';
}

function generateReport(){
  if (AppState.downtimeStarted) {
    const ctl = document.getElementById('currentTimeLine');
    if (ctl) ctl.style.display = 'block';
    updateProgressIndicators();
  }
  
  const headerId = 'reportHeaderTemp';
  let hdr = document.getElementById(headerId);
  if (!hdr) {
    const panel = document.getElementById('progressPanel');
    hdr = document.createElement('div');
    hdr.id = headerId;
    hdr.style.marginBottom = '8px';
    hdr.style.fontSize = '14px';
    hdr.style.fontWeight = '600';
    const cust = document.getElementById('customerName')?.value || '';
    const cycle = document.getElementById('transformCycle')?.value || '';
    const ts = new Date().toLocaleString();
    hdr.textContent = `Customer: ${cust}   •   Transform Cycle: ${cycle}   •   Snapshot: ${ts}`;
    panel.insertBefore(hdr, panel.firstChild.nextSibling);
  } else {
    const cust = document.getElementById('customerName')?.value || '';
    const cycle = document.getElementById('transformCycle')?.value || '';
    const ts = new Date().toLocaleString();
    hdr.textContent = `Customer: ${cust}   •   Transform Cycle: ${cycle}   •   Snapshot: ${ts}`;
  }
  window.print();
}

</script>

<!-- Register the service worker for Progressive Web App support -->
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('service-worker.js')
        .catch(function(err) {
          console.error('Service worker registration failed:', err);
        });
    });
  }
</script>

<!-- Firebase realtime sync -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp, collection } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAredpIvTx0c7uxn23HZoD3YkTgcG4cHbk",
    authDomain: "downtime-tracking-135f6.firebaseapp.com",
    projectId: "downtime-tracking-135f6",
    storageBucket: "downtime-tracking-135f6.firebaseapp.com",
    messagingSenderId: "422856401277",
    appId: "1:422856401277:web:7b10cb426abf816d74ec14",
    measurementId: "G-CJ2F30SYRY"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // URL params
  const url = new URL(window.location.href);
  let customerParam = url.searchParams.get("customer") || "";
  let phaseParam = url.searchParams.get("phase") || url.searchParams.get("transformCycle") || "";
  const viewerForced = url.searchParams.get("viewer") === "1";
  const nameInput = document.getElementById("customerName");
  const phaseInput = document.getElementById("transformCycle");

  if (!customerParam && nameInput && nameInput.value) customerParam = nameInput.value;
  if (!phaseParam && phaseInput && phaseInput.value) phaseParam = phaseInput.value;

  const toKey = s => (s||"default").toString().trim().toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"") || "default";
  const customerKey = toKey(customerParam);

  if (!url.searchParams.get("customer")) { url.searchParams.set("customer", customerParam || "default"); }
  if (phaseParam && !url.searchParams.get("phase") && !url.searchParams.get("transformCycle")) {
    url.searchParams.set("phase", phaseParam);
  }
  if (!url.searchParams.get("customer") || (phaseParam && !url.searchParams.get("phase"))) {
    history.replaceState(null, "", url.toString());
  }

  if (nameInput && customerParam) nameInput.value = customerParam;
  if (phaseInput && phaseParam) phaseInput.value = phaseParam;

  // Overlay
  (function overlay(){
    const right = document.createElement("div");
    right.style.cssText = "position:fixed;right:10px;bottom:10px;background:#fff;border:1px solid #dcdcdc;border-radius:8px;padding:10px 12px;font:12px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;box-shadow:0 2px 6px rgba(0,0,0,.08);z-index:100000;min-width:280px";
    right.innerHTML = `<div style="display:flex;gap:6px;align-items:center;justify-content:space-between;margin-bottom:6px;">
        <div><strong>Customer:</strong> <span id="rt-customer" style="font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace">${customerParam || "default"}</span></div>
        <button id="rt-copy" style="padding:4px 8px;border:1px solid #ccc;border-radius:6px;cursor:pointer;background:#f9f9fb;">Copy link</button>
      </div>
      <div style="display:flex;gap:6px;align-items:center;justify-content:space-between;">
        <span id="rt-online" style="display:inline-block;padding:2px 8px;border:1px solid #dcdcdc;border-radius:999px;">0 online</span>
        <span id="rt-mode" style="font-weight:600;color:#444">mode: —</span>
      </div>
      <div id="rt-viewer-panel" style="display:none;margin-top:8px">
        <div style="font-size:12px;margin-bottom:2px"><b>Status:</b> <span id="rt-status">—</span></div>
        <div style="font-size:12px;margin-bottom:4px"><b>Start:</b> <span id="rt-start">—</span></div>
        <div style="font-size:12px;margin-bottom:6px"><b>ETA:</b> <span id="rt-eta">—</span></div>
        <div style="position:relative;height:10px;border:1px solid #dcdcdc;border-radius:999px;overflow:hidden;background:#f2f3f6">
          <div id="rt-bar" style="position:absolute;left:0;top:0;bottom:0;width:0%"></div>
        </div>
        <div id="rt-bar-label" style="font-size:11px;margin-top:4px;text-align:right">0%</div>
      </div>`;
    document.body.appendChild(right);
    document.getElementById("rt-copy").onclick = async () => {
      await navigator.clipboard.writeText(window.location.href);
      const btn = document.getElementById("rt-copy"); const prev = btn.textContent; btn.textContent="Copied"; setTimeout(()=>btn.textContent=prev, 1000);
    };
    const bar = right.querySelector("#rt-bar");
    bar.style.background = "linear-gradient(90deg, rgba(0,0,0,.2), rgba(0,0,0,.5))";

    const left = document.createElement("div");
    left.style.cssText = "position:fixed;left:10px;bottom:10px;z-index:100001";
    left.innerHTML = `<button id="rt-reset" title="Reset session for all viewers" style="padding:10px 14px;border:none;border-radius:8px;cursor:pointer;background:#d32f2f;color:#fff;font-weight:600;box-shadow:0 2px 6px rgba(0,0,0,.15)">Reset</button>`;
    document.body.appendChild(left);

    const top = document.createElement("div");
    top.id = "rt-status-banner";
    top.style.cssText = "position:fixed;top:6px;left:50%;transform:translateX(-50%);padding:6px 10px;background:#fff;border:1px solid #dcdcdc;border-radius:999px;box-shadow:0 2px 6px rgba(0,0,0,.08);font:13px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;z-index:100002;display:none";
    top.innerHTML = `<b>Status:</b> <span id="rt-status-top">—</span>`;
    document.body.appendChild(top);
  })();

  // Auth + presence
  await signInAnonymously(auth);
  const uid = await new Promise((resolve) => onAuthStateChanged(auth, (u)=>{ if(u){ resolve(u.uid); } }));
  const presenceRef = doc(db, "sessions", customerKey, "presence", uid);
  async function upsertPresence(){
    try { await setDoc(presenceRef, { name: (nameInput && nameInput.value) || customerParam || "Guest", lastActive: serverTimestamp() }, { merge: true }); }
    catch(e){ console.error("[presence] setDoc failed:", e); }
  }
  await upsertPresence();
  setInterval(upsertPresence, 20000);
  window.addEventListener("beforeunload", async () => { try{ await setDoc(presenceRef, { lastActive: serverTimestamp(), leftAt: serverTimestamp() }, { merge:true }); }catch{} });

  // Online indicator
  onSnapshot(collection(db, "sessions", customerKey, "presence"), (snap) => {
    const now = Date.now(); let online = 0;
    snap.forEach(d => { const t = d.data().lastActive?.toMillis?.() || 0; if (now - t < 45000) online++; });
    const el = document.getElementById("rt-online"); if (el) el.textContent = `${online} online`;
  });

  // Helpers
  const sessionRef = doc(db, "sessions", customerKey);
  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms)); await sleep(200);
  function S(){ return window._AppStateRef || window.AppState || (window._AppStateRef = { runbooks:[], downtimeStarted:false, downtimePaused:false, pausedDuration:0, downtimeDuration:24, downtimeStartTime:null }); }

  function lockFieldsForStarted(started){
    const lock = (el, yes) => {
      if (!el) return;
      if (yes) { el.setAttribute("disabled","true"); el.style.pointerEvents="none"; el.style.opacity="0.7"; el.title="Locked while timeline is running"; }
      else { el.removeAttribute("disabled"); el.style.pointerEvents=""; el.style.opacity=""; el.title=""; }
    };
    lock(document.getElementById("customerName"), !!started);
    lock(document.getElementById("transformCycle"), !!started);
  }

  function serialize(){
    const s = S();
    const cn = (document.getElementById("customerName") || {}).value || "";
    const tp = (document.getElementById("transformCycle") || {}).value || "";
    return {
      runbooks: (s.runbooks || []).map(r=>({...r})),
      downtimeStarted: !!s.downtimeStarted,
      downtimeStartTime: s.downtimeStartTime ? new Date(s.downtimeStartTime).toISOString() : null,
      downtimeDuration: s.downtimeDuration ?? 24,
      downtimePaused: !!s.downtimePaused,
      pausedDuration: s.pausedDuration ?? 0,
      customerName: cn,
      transformCycle: tp
    };
  }

  // Viewer UI helpers
  function statusString(s){
    const now = Date.now();
    if (!s.downtimeStarted || !s.downtimeStartTime) return "Not started";
    const start = (s.downtimeStartTime instanceof Date) ? s.downtimeStartTime : new Date(s.downtimeStartTime);
    const endMs = start.getTime() + (s.downtimeDuration||24)*3600*1000;
    if (s.downtimePaused) return "Paused";
    if (now >= endMs) return "Completed";
    return "Running";
  }
  function updateViewerStatusBanner(){
    const s = S();
    const isViewer = !canWrite();
    const banner = document.getElementById("rt-status-banner");
    const topTxt = document.getElementById("rt-status-top");
    const panelTxt = document.getElementById("rt-status");
    const text = statusString(s);
    if (panelTxt) panelTxt.textContent = text;
    if (banner) {
      banner.style.display = isViewer ? "block" : "none";
      if (topTxt) topTxt.textContent = text;
    }
  }
  function computePercent(){
    const s = S();
    if (!s.downtimeStarted || !s.downtimeStartTime) return 0;
    const start = (s.downtimeStartTime instanceof Date) ? s.downtimeStartTime : new Date(s.downtimeStartTime);
    const durMs = (typeof s.downtimeDuration === "number" ? s.downtimeDuration : 24) * 3600 * 1000;
    let pct = (Date.now() - start.getTime()) / durMs;
    pct = Math.max(0, Math.min(1, pct));
    return pct;
  }
  function updateViewerProgress(){
    const s = S();
    const startEl = document.getElementById("rt-start");
    const etaEl = document.getElementById("rt-eta");
    const bar = document.getElementById("rt-bar");
    const lbl = document.getElementById("rt-bar-label");
    const pct = computePercent();
    if (!s.downtimeStarted || !s.downtimeStartTime) {
      if (startEl) startEl.textContent = "—";
      if (etaEl) etaEl.textContent = "—";
      if (bar) bar.style.width = "0%";
      if (lbl) lbl.textContent = "0%";
      return;
    }
    const start = (s.downtimeStartTime instanceof Date) ? s.downtimeStartTime : new Date(s.downtimeStartTime);
    const durMs = (typeof s.downtimeDuration === "number" ? s.downtimeDuration : 24) * 3600 * 1000;
    const end = new Date(start.getTime() + durMs);
    if (startEl) startEl.textContent = start.toLocaleString();
    if (etaEl) etaEl.textContent = end.toLocaleString();
    const pctStr = Math.round(pct * 100) + "%";
    if (bar) bar.style.width = pctStr;
    if (lbl) lbl.textContent = pctStr;
  }
  function updateViewerTimelineVisual(){
    if (typeof window.updateTimeline === "function") { 
      try { window.updateTimeline(); return; } catch {}
    }
    const pct = computePercent() * 100;
    const cursor = document.querySelector("#statusLine, .status-line, #currentStatusLine, .timeline-now, .timeline-cursor");
    if (cursor) {
      cursor.style.left = pct + "%";
      cursor.style.transform = "translateX(-50%)";
    }
    const fill = document.querySelector("#timelineProgress, .timeline-progress, #progressFill, .progress-fill, .timeline-fill");
    if (fill) {
      fill.style.width = pct + "%";
    }
  
  try {
    if (AppState.downtimeStarted && AppState.downtimeStartTime) {
      const now = new Date();
      const elapsedMs = now - AppState.downtimeStartTime - (AppState.pausedDuration || 0);
      const elapsed = elapsedMs / 3600000;
      const pixelsPerHour = 60;
      const linePosition = Math.min(elapsed * pixelsPerHour, AppState.downtimeDuration * pixelsPerHour);
      const currentLine = document.getElementById('currentTimeLine');
      if (currentLine) {
        currentLine.style.left = `${linePosition}px`;
        currentLine.style.display = 'block';
      }
    }
  } catch {}
}

  function applyRemoteState(st){
    const s = S();
    Object.assign(s, {
      runbooks: Array.isArray(st.runbooks) ? st.runbooks : [],
      downtimeStarted: !!st.downtimeStarted,
      downtimeDuration: typeof st.downtimeDuration === "number" ? st.downtimeDuration : 24,
      downtimePaused: !!st.downtimePaused,
      pausedDuration: typeof st.pausedDuration === "number" ? st.pausedDuration : 0,
      downtimeStartTime: st.downtimeStartTime ? new Date(st.downtimeStartTime) : null
    });

    const cn = document.getElementById("customerName");
    const tp = document.getElementById("transformCycle");
    if (cn && typeof st.customerName === "string" && cn.value !== st.customerName) cn.value = st.customerName;
    if (tp && typeof st.transformCycle === "string" && tp.value !== st.transformCycle) tp.value = st.transformCycle;

    lockFieldsForStarted(!!st.downtimeStarted);

    try {
      if (typeof window.renderRunbookTable === "function") window.renderRunbookTable();
      if (typeof window.updateClock === "function") window.updateClock();
    } catch {}

    updateViewerStatusBanner();
    updateViewerProgress();
    updateViewerTimelineVisual();
  }

  // Mode
  let initialApplied=false, lastSent=null, writing=false, remoteController=null, controllerAttempted=false;
  function canWrite(){ return !viewerForced && remoteController === uid; }
  function setReadOnlyUI(ro){
    const modeEl = document.getElementById("rt-mode");
    if (modeEl) modeEl.textContent = ro ? "mode: VIEWER" : "mode: HOST";
    const nodes = document.querySelectorAll("button, input, select, textarea");
    nodes.forEach(el => { if (!el) return; if (el.id === "rt-copy" || el.id === "rt-reset") return;
      if (ro) { el.setAttribute("disabled","true"); el.style.pointerEvents="none"; el.style.opacity="0.6"; }
      else { el.removeAttribute("disabled"); el.style.pointerEvents=""; el.style.opacity=""; } });
    lockFieldsForStarted(!!S().downtimeStarted);
    const panel = document.getElementById("rt-viewer-panel");
    if (panel) panel.style.display = ro ? "block" : "none";
    const statusBanner = document.getElementById("rt-status-banner");
    if (statusBanner) statusBanner.style.display = ro ? "block" : "none";
    updateViewerStatusBanner();
    updateViewerProgress();
    updateViewerTimelineVisual();
  }

  // Ensure doc exists
  try {
    const s = await getDoc(sessionRef);
    if (!s.exists()) await setDoc(sessionRef, { state: serialize(), updatedAt: serverTimestamp() }, { merge:true });
  } catch(e){ console.error("[session] ensure failed:", e); }

  // Subscribe to session
  onSnapshot(sessionRef, async (snap) => {
    const data = snap.data() || {};
    remoteController = data.controllerUid || null;
    if (data.state) applyRemoteState(data.state);

    if (!remoteController && !controllerAttempted && !viewerForced) {
      controllerAttempted = true;
      try { await setDoc(sessionRef, { controllerUid: uid, controllerSetAt: serverTimestamp() }, { merge:true }); } catch {}
    }

    setReadOnlyUI(!canWrite());

    if (!initialApplied) {
      initialApplied = true;
      try { lastSent = JSON.stringify(serialize()); } catch {}
    }
  });

  // Push (host only)
  async function push(reason="debounce"){
    if (!initialApplied || !canWrite()) return;
    try{
      const nowJson = JSON.stringify(serialize());
      if (nowJson === lastSent || writing) return;
      writing = true;
      await updateDoc(sessionRef, { state: JSON.parse(nowJson), updatedAt: serverTimestamp(), reason });
      lastSent = nowJson;
    }catch(e){
      try{ await setDoc(sessionRef, { state: serialize(), updatedAt: serverTimestamp(), reason }, { merge:true });
           lastSent = JSON.stringify(serialize()); }catch(e2){ console.error("[session] write failed:", e2); }
    }finally{ writing=false; }
  }
  let timer=null;
  const schedule = () => { clearTimeout(timer); timer = setTimeout(()=>push("debounce"), 250); };

  // Hook mutators
  ["startDowntime","pauseDowntime","resumeDowntime","stopDowntime","addRunbookRow","removeRunbook","clearRunbook","updateSequence","updateStrategy","updatePhase","updateRunblock","updateResponsibility","updateCritical","updateScheduleTime","updateDurationTime","toggleCompleted","startTimeline","startTimer"]
    .forEach(fn => { const orig = window[fn]; if (typeof orig==="function"){ window[fn]=function(...a){ const r=orig.apply(this,a); schedule(); return r; }; } });

  // Watch URL-related fields (host)
  const watch = (id, paramName) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener("change", () => {
      schedule();
      if (canWrite()) {
        const v = el.value || "";
        if (paramName === "customer") url.searchParams.set("customer", v || "default");
        if (paramName === "phase") url.searchParams.set("phase", v);
        history.replaceState(null, "", url.toString());
      }
    }, true);
    el.addEventListener("input", () => { if (canWrite()) schedule(); }, true);
  };
  watch("customerName", "customer");
  watch("transformCycle", "phase");

  // Periodic viewer refresh ticks
  setInterval(() => {
    if (!canWrite()) {
      updateViewerStatusBanner();
      updateViewerProgress();
      updateViewerTimelineVisual();
      if (typeof window.updateClock === "function") { try { window.updateClock(); } catch {} }
    }
  }, 1000);

  // Reset (HOST-only)
  async function handleReset(){
    if (!canWrite()) { alert("Only the host can reset the session."); return; }
    const yes = confirm("Reset the session for ALL viewers? This will clear customer, phase, runbooks and all timing.");
    if (!yes) return;

    const cn = document.getElementById('customerName'); if (cn) cn.value = "";
    const tp = document.getElementById('transformCycle'); if (tp) tp.value = "";

    const defaultState = {
      runbooks: [],
      downtimeStarted: false,
      downtimeStartTime: null,
      downtimeDuration: 24,
      downtimePaused: false,
      pausedDuration: 0,
      customerName: "",
      transformCycle: ""
    };
    try {
      await updateDoc(sessionRef, { state: defaultState, updatedAt: serverTimestamp(), reason: "reset" });
    } catch (e) {
      await setDoc(sessionRef, { state: defaultState, updatedAt: serverTimestamp(), reason: "reset" }, { merge: true });
    }

    lockFieldsForStarted(false);

    try {
      url.searchParams.delete('phase');
      url.searchParams.delete('transformCycle');
      url.searchParams.set('customer','default');
      history.replaceState(null, "", url.toString());
    } catch {}

    updateViewerStatusBanner();
    updateViewerProgress();
    updateViewerTimelineVisual();
  }
  const resetBtn = document.getElementById("rt-reset");
  if (resetBtn) resetBtn.addEventListener("click", handleReset);
</script>