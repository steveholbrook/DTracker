<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>DTracker Diagnostics</title><style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:16px}.ok{color:#0a6d12}.err{color:#b00020}.box{border:1px solid #ddd;border-radius:8px;padding:12px;margin:12px 0;background:#fafafa}code,pre{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}</style><h1>DTracker Diagnostics</h1><p>This checks Anonymous Auth, Presence writes, and Session state for the current <b>?customer=</b>.</p><div class="box"><div><b>Customer:</b> <span id="cust">(none)</span></div><div><b>UID:</b> <span id="uid">—</span></div><div><b>Auth:</b> <span id="auth" class="err">pending…</span></div><div><b>Presence write:</b> <span id="presence" class="err">pending…</span></div><div><b>Online count:</b> <span id="online">0</span></div><div><b>Session doc exists:</b> <span id="session">—</span></div><div><b>Controller UID:</b> <span id="controller">—</span></div><div><b>Last session state:</b> <pre id="state" style="max-height:220px;overflow:auto">—</pre></div></div><script type="module">import{initializeApp as e}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";import{getFirestore as t,doc as n,getDoc as o,setDoc as a,onSnapshot as s,serverTimestamp as i,collection as r}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";import{getAuth as d,signInAnonymously as c,onAuthStateChanged as l}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";const m={apiKey:"AIzaSyAredpIvTx0c7uxn23HZoD3YkTgcG4cHbk",authDomain:"downtime-tracking-135f6.firebaseapp.com",projectId:"downtime-tracking-135f6",storageBucket:"downtime-tracking-135f6.firebasestorage.app",messagingSenderId:"422856401277",appId:"1:422856401277:web:7b10cb426abf816d74ec14",measurementId:"G-CJ2F30SYRY"};const u=t(e(m)),f=d();const p=o=>document.getElementById(o),h=new URL(window.location.href),g=(h.searchParams.get("customer")||"default").toLowerCase().trim().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"")||"default";p("cust").textContent=`${h.searchParams.get("customer")||"default"}  (key: ${g})`;try{await c(f),p("auth").textContent="OK (Anonymous)",p("auth").className="ok"}catch(e){p("auth").textContent="Auth failed: "+(e?.message||e),p("auth").className="err"}const y=await new Promise((e=>l(f,(t=>{t&&(p("uid").textContent=t.uid,e(t.uid))})))),b=n(u,"sessions",g,"presence",y);async function v(){try{await a(b,{name:"Diagnostics",lastActive:i()},{merge:!0}),p("presence").textContent="OK",p("presence").className="ok"}catch(e){p("presence").textContent="Presence write failed: "+(e?.message||e),p("presence").className="err"}}await v(),setInterval(v,2e4),s(r(u,"sessions",g,"presence"),(e=>{const t=Date.now();let n=0;e.forEach((e=>{const o=e.data().lastActive?.toMillis?.()||0;t-o<45e3&&n++})),p("online").textContent=n}));const S=n(u,"sessions",g);try{(await o(S)).exists()||await a(S,{createdAt:i(),state:{},customer:h.searchParams.get("customer")||"default"},{merge:!0}),p("session").textContent="Yes"}catch(e){p("session").textContent="No (write failed): "+(e?.message||e)}s(S,(e=>{const t=e.data()||{};p("controller").textContent=t.controllerUid||"—",p("state").textContent=JSON.stringify(t.state||t,null,2)}));</script>