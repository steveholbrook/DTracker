<!doctype html>
<html lang="en">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>DTracker Diagnostics</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:16px;}
  code,pre{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;}
  .ok{color:#0a6d12}.err{color:#b00020}
  .box{border:1px solid #ddd;border-radius:8px;padding:12px;margin:12px 0;background:#fafafa}
</style>
<h1>DTracker Diagnostics</h1>
<p>This checks Anonymous Auth, Presence writes, and Session state for the current <b>?customer=</b>.</p>
<div class="box">
  <div><b>Customer:</b> <span id="cust">(none)</span></div>
  <div><b>UID:</b> <span id="uid">—</span></div>
  <div><b>Auth:</b> <span id="auth" class="err">pending…</span></div>
  <div><b>Presence write:</b> <span id="presence" class="err">pending…</span></div>
  <div><b>Online count:</b> <span id="online">0</span></div>
  <div><b>Session doc exists:</b> <span id="session">—</span></div>
  <div><b>Last session state:</b> <pre id="state" style="max-height:220px;overflow:auto">—</pre></div>
</div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, serverTimestamp, collection } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAredpIvTx0c7uxn23HZoD3YkTgcG4cHbk",
    authDomain: "downtime-tracking-135f6.firebaseapp.com",
    projectId: "downtime-tracking-135f6",
    storageBucket: "downtime-tracking-135f6.firebasestorage.app",
    messagingSenderId: "422856401277",
    appId: "1:422856401277:web:7b10cb426abf816d74ec14",
    measurementId: "G-CJ2F30SYRY"
  };

  const el = id => document.getElementById(id);
  const url = new URL(window.location.href);
  const customerParam = url.searchParams.get("customer") || "default";
  const customerKey = (customerParam||"default").toLowerCase().trim().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"") || "default";
  el("cust").textContent = customerParam + "  (key: " + customerKey + ")";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let uid = null;
  try {
    await signInAnonymously(auth);
    el("auth").textContent = "OK (Anonymous)";
    el("auth").className = "ok";
  } catch (e) {
    el("auth").textContent = "Auth failed: " + (e && e.message || e);
    el("auth").className = "err";
    console.error("[auth]", e);
  }
  onAuthStateChanged(auth, (u) => { if (u) { uid = u.uid; el("uid").textContent = uid; }});

  const presenceRef = doc(db, "sessions", customerKey, "presence", "uid_" + (uid || Math.random().toString(36).slice(2)));
  async function touchPresence() {
    try {
      await setDoc(presenceRef, { name: "Diagnostics", lastActive: serverTimestamp() }, { merge: true });
      el("presence").textContent = "OK";
      el("presence").className = "ok";
    } catch (e) {
      el("presence").textContent = "Presence write failed: " + (e && e.message || e);
      el("presence").className = "err";
      console.error("[presence]", e);
    }
  }
  await touchPresence();
  setInterval(touchPresence, 20000);

  const presenceCol = collection(db, "sessions", customerKey, "presence");
  onSnapshot(presenceCol, (snap) => {
    const now = Date.now();
    let online = 0;
    snap.forEach(d => {
      const data = d.data();
      const ts = data.lastActive && data.lastActive.toMillis ? data.lastActive.toMillis() : 0;
      if (now - ts < 45000) online++;
    });
    el("online").textContent = online;
  });

  const sessionRef = doc(db, "sessions", customerKey);
  try {
    const s = await getDoc(sessionRef);
    if (!s.exists()) {
      await setDoc(sessionRef, { createdAt: serverTimestamp(), state: {}, customer: customerParam }, { merge: true });
    }
    el("session").textContent = "Yes";
  } catch (e) {
    el("session").textContent = "No (write failed): " + (e && e.message || e);
    console.error("[session]", e);
  }
  onSnapshot(sessionRef, (snap) => {
    const data = snap.data() || {};
    el("state").textContent = JSON.stringify(data.state || data, null, 2);
  });
</script>
</html>
